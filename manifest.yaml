type: install
id: manifold
version: '1.0'
appVersion: latest
name: Manifold
logo: https://raw.githubusercontent.com/TaylorJadin/manifold-jps/main/icon.png
homepage: https://manifoldapp.org
categories: 
- apps/education
description: 
  text: "Built by scholars and publishers, for scholars and publishers. Manifold is a collaboration between the CUNY Graduate Center, the University of Minnesota Press, and Cast Iron Coding, and each group brings a unique perspective to the project: scholarship, publishing, and technology."
  short: "Manifold is the friendly, scalable, sustainable way to add the web to your publishing workflow."

globals:
  shortname: manifold
  path: /root/manifold
  repo: https://github.com/ManifoldScholar/manifold-docker-compose.git
  manifold_tag: 

ssl: true

nodes:
  - cloudlets: 4
    count: 1
    nodeGroup: bl
    nodeType: nginx
  - nodeType: dockerengine
    nodeGroup: cp
    cloudlets: 32
    fixedcloudlets: 1
    displayName: App Server
    volumes: ["${globals.path}"]

settings:
  domain:
    fields:
      - name: displayfield
        type: displayfield
        hideLabel: true
        markup: |
          The new domain should already have an A record pointed at this environment's IP address.
      - name: domain
        hideLabel: true
        caption: Domain
        type: string
        vtype: extdomain

onInstall:
  - manifoldSetup
  - nginxSetup

actions:
  manifoldSetup: 
    - cmd[cp]: |-
        mkdir -p ${globals.path}
        cd ${globals.path}
        git clone ${globals.repo} --depth 1 .
        rm MANIFOLD_VERSION
        rm .gitignore
        rm -rf .git
        LATEST_STABLE=$(curl -s https://api.github.com/repos/ManifoldScholar/manifold-docker-compose/tags | grep "name" | grep -v "-" | head -1 | cut -d '"' -f4)
        echo "MANIFOLD_TAG=$LATEST_STABLE" > .env
        sed -i \
        -e "s|DOMAIN=.*|DOMAIN=${env.domain}|" \
        -e "s|CLIENT_BROWSER_API_URL=.*|CLIENT_BROWSER_API_URL=https://${env.domain}|" \
        -e "s|CLIENT_BROWSER_API_CABLE_URL=.*|CLIENT_BROWSER_API_CABLE_URL=https://${env.domain}/cable|" \
        -e "s|SSL_ENABLED=.*|SSL_ENABLED=true|" \
        environment/manifold.env
        sed -i \
        -e 's|- "4000:80"|- "80:80"|' \
        -e 's|- "4001:443"|- "443:443"|' \
        docker-compose.yml
        docker-compose up -d
        # wait for the database to be ready
        sleep 10
        # Add admin user
        docker exec manifold_api_rails_1 rails manifold:user:create:admin['${user.email}','${user.appPassword}','Site','Admin']
        # Fix email (https://github.com/ManifoldScholar/manifold/issues/3584)
        docker exec manifold_api_rails_1 touch /opt/manifold/api/public/mail_styles.css
    - env.file.AddFavorite:
        nodeGroup: cp
        path: ${globals.path}
        keyword: ${globals.shortname}
  nginxSetup:
    - replaceInFile:
        - nodeType: nginx
          path: /etc/nginx/nginx-jelastic.conf
          replacements:
            - pattern: 'http://default_upstream;'
              replacement: 'https://default_upstream;'
            - pattern: 'server ${nodes.cp.address};'
              replacement: 'server ${nodes.cp.address}:443;' 
    - restartNodes:
        nodeType: nginx
    
success: | 
  **${env.displayName}**: [https://${env.domain}/](https://${env.domain}/)

  **Username:** ${user.email}

  **Password:** ${user.appPassword}

  Find out more about using this docker-based Manifold install by [checking out the official Manifold documentation](https://manifoldscholar.github.io/manifold-docusaurus/docs).